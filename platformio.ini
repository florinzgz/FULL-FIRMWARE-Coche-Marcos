; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; ============================================================================
; Hardware: ESP32-S3-WROOM-2 N16R8 (16MB Flash + 8MB PSRAM)
; Flash: 16MB QIO mode (Quad I/O - 4 data lines, 3.3V)
; PSRAM: 8MB QSPI mode (Quad SPI - 4 data lines, 3.3V)
; ============================================================================
; MEMORY CONFIGURATION FOR ARDUINO-ESP32:
; - Flash: QIO mode (4-bit, safe)
; - PSRAM: QSPI mode (4-bit, 3.3V)
; - memory_type = qio_qspi (Flash + PSRAM configuration)
; ============================================================================

[platformio]
boards_dir = boards

[env:esp32-s3-n16r8]
platform = espressif32@6.12.0
board = esp32s3_n16r8
framework = arduino

build_type = debug

monitor_speed = 115200
upload_speed = 921600
upload_port = COM6
monitor_port = COM6

; ================= Flash & Memory Configuration =================
; Flash: 16MB QIO mode (4-bit, 3.3V)
; PSRAM: 8MB QSPI mode (4-bit, 3.3V)
board_build.partitions = partitions/n16r8_ota.csv
board_build.sdkconfig = sdkconfig/n16r8.defaults
board_build.arduino.memory_type = qio_qspi

; ================= Stack Size Configuration =================
; üîí v2.17.1: Stack size configuration for bootloop prevention
; Arduino-ESP32 framework uses board_build options, not CONFIG_ macros
board_build.arduino.loop_stack_size = 32768  ; 32KB loop stack (default 8KB)
board_build.arduino.event_stack_size = 16384 ; 16KB event stack (default 4KB)

build_src_filter = +<*> -<test/>

extra_scripts =
    pre:install_deps.py
    pre:tools/preflight_validator.py

; ================= LIBRER√çAS =================
lib_deps =
    bodmer/TFT_eSPI @ 2.5.43
    dfrobot/DFRobotDFPlayerMini @ 1.0.6
    milesburton/DallasTemperature @ 3.11.0
    paulstoffregen/OneWire @ 2.3.8
    adafruit/Adafruit PWM Servo Driver Library @ 3.0.2
    adafruit/Adafruit BusIO @ 1.17.4
    robtillaart/INA226 @ 0.6.5
    fastled/FastLED @ 3.10.3
    adafruit/Adafruit MCP23017 Arduino Library @ 2.3.2
    https://github.com/WifWaf/TCA9548A

lib_ignore =
    WebServer

; ================= FLAGS =================
build_flags =
    ; ---- PSRAM ----
    ; PSRAM configured via board_build.arduino.memory_type = qio_qspi
    -DBOARD_HAS_PSRAM

    ; ---- DEBUG ----
    -DCORE_DEBUG_LEVEL=3

    ; ---- TFT_eSPI ----
    -DUSER_SETUP_LOADED=1
    -DST7796_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    -DTFT_MISO=12
    -DTFT_MOSI=11
    -DTFT_SCLK=10
    -DTFT_CS=16
    -DTFT_DC=13
    -DTFT_RST=14
    -DTFT_BL=42
    -DTFT_BACKLIGHT_ON=1
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=20000000
    -DSPI_TOUCH_FREQUENCY=2500000
    -DTOUCH_CS=21
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    -DI2C_FREQUENCY=400000

; ===================================================================
; RELEASE
; ===================================================================
[env:esp32-s3-n16r8-release]
extends = env:esp32-s3-n16r8
build_flags =
    ${env:esp32-s3-n16r8.build_flags}
    -DCORE_DEBUG_LEVEL=0
    -O3
    -DNDEBUG


; ===================================================================
; TOUCH DEBUG
; ===================================================================
[env:esp32-s3-n16r8-touch-debug]
extends = env:esp32-s3-n16r8
build_flags =
    ${env:esp32-s3-n16r8.build_flags}
    -DSPI_TOUCH_FREQUENCY=1000000
    -DTOUCH_DEBUG
    -DZ_THRESHOLD=250
    -DCORE_DEBUG_LEVEL=5


; ===================================================================
; NO TOUCH
; ===================================================================
[env:esp32-s3-n16r8-no-touch]
extends = env:esp32-s3-n16r8
build_flags =
    ${env:esp32-s3-n16r8.build_flags}
    -DDISABLE_TOUCH


; ===================================================================
; STANDALONE DISPLAY
; ===================================================================
[env:esp32-s3-n16r8-standalone]
extends = env:esp32-s3-n16r8
board_build.partitions = partitions/n16r8_standalone.csv
build_flags =
    ${env:esp32-s3-n16r8.build_flags}
    -DSTANDALONE_DISPLAY
    -DDISABLE_SENSORS

; ===================================================================
; STANDALONE DISPLAY DEBUG
; ===================================================================
[env:esp32-s3-n16r8-standalone-debug]
extends = env:esp32-s3-n16r8
board_build.partitions = partitions/n16r8_standalone.csv
build_flags =
    ${env:esp32-s3-n16r8.build_flags}
    -DSTANDALONE_DISPLAY
    -DDISABLE_SENSORS
    -DCORE_DEBUG_LEVEL=5


; ===================================================================
; MIGRATION HISTORY
; ===================================================================
; PHASE 14 (2026-01): Hardware migration from N32R16V to N16R8
; - Changed from 32MB OPI Flash + 16MB OPI PSRAM @ 1.8V
; - To 16MB QIO Flash + 8MB QSPI PSRAM @ 3.3V
; - All environments updated to use esp32s3_n16r8 board
; - Partition tables resized for 16MB flash
; - SDK configuration changed from OCT to QUAD PSRAM mode
; 
; Previously (before PHASE 14), there was an [env:esp32-s3-n32r16v]
; environment using OPI PSRAM. This has been permanently deprecated.
; All ESP32-S3 environments now use the N16R8 configuration with
; QIO flash and QSPI PSRAM at 3.3V.
; ===================================================================

