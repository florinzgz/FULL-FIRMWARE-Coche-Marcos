; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; ============================================================================
; Version: 2.8.4
; Date: 2025-11-30
; Hardware: ESP32-S3-DevKitC-1 (44 pines)
; ============================================================================
; 
; Changelog v2.8.4:
; - Unificados directorios src/menu y src/menus en src/menu/
; - Implementaci√≥n completa de menu_obstacle_config.cpp
;   (sliders de distancia, toggles de sensores, config alertas)
;
; Changelog v2.8.3:
; - A√±adidas 6 nuevas implementaciones: eeprom_persistence, led_control_menu,
;   menu_encoder_calibration, menu_led_control, menu_power_config, menu_sensor_config
; - Corregidos overflows de enteros en sliders
; - A√±adido helper hueToRGB565() para eliminar c√≥digo duplicado
; - Estandarizados nombres de patrones LED
; - Mejorados thresholds de advertencia en sensor config
; ============================================================================

[env:esp32-s3-devkitc]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_size = 16MB
board_build.partitions = default.csv

monitor_speed = 115200
upload_speed = 921600
upload_port = COM3
monitor_port = COM3

lib_deps =
    bodmer/TFT_eSPI @ ^2.5.43
    dfrobot/DFRobotDFPlayerMini @ ^1.0.6
    milesburton/DallasTemperature@^4.0.5
    paulstoffregen/OneWire@^2.3.8
    https://github.com/adafruit/Adafruit-PWM-Servo-Driver-Library.git
    RobTillaart/INA226 @ ^0.6.4
    https://github.com/PaulStoffregen/XPT2046_Touchscreen.git
    fastled/FastLED @ 3.6.0
    adafruit/Adafruit MCP23017 Arduino Library @ ^2.3.2

build_flags =
    -DCORE_DEBUG_LEVEL=5
    -DUSER_SETUP_LOADED
    -std=gnu++17
    -DLOAD_GLCD
    -DLOAD_FONT2
    -DLOAD_FONT4
    -DLOAD_FONT6
    -DLOAD_FONT7
    -DLOAD_FONT8
    -DSMOOTH_FONT
    -Iinclude
    
    ; ========================================
    ; TFT_eSPI configuration for ST7796S (480x320)
    ; ESP32-S3-N16R8 con HSPI
    ; ‚úÖ v2.8.0: Documentaci√≥n sensores temperatura actualizada
    ; ‚úÖ v2.3.0: Pines reorganizados para evitar strapping pins
    ; ‚ö†Ô∏è NOTA: Estos pines DEBEN coincidir con pins.h
    ; TFT_eSPI requiere definici√≥n en tiempo de compilaci√≥n via build flags
    ; ya que no puede leer pins.h din√°micamente. Mantener sincronizados.
    ; ========================================
    -DST7796_DRIVER
    ; üîí v2.8.2: CRITICAL FIX - TFT_WIDTH/HEIGHT are NATIVE dimensions BEFORE rotation
    ; ST7796S native orientation is portrait (320x480)
    ; With setRotation(3), display becomes landscape (480x320)
    ; Wrong: TFT_WIDTH=480, TFT_HEIGHT=320 (caused half-screen rendering)
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    
    ; Pin mapping TFT (must match pins.h v2.3.0)
    ; Fuente de verdad: include/pins.h - actualizar ambos archivos si cambian
    -DTFT_CS=16
    -DTFT_DC=13
    -DTFT_RST=14
    -DTFT_MOSI=11
    -DTFT_MISO=12
    -DTFT_SCLK=10
    -DTFT_BL=42
    
    ; ‚úÖ v2.3.0: Touch pins optimizados (XPT2046)
    ; TOUCH_CS movido de GPIO 3 ‚Üí GPIO 21 (pin seguro, no strapping)
    ; TOUCH_IRQ movido de GPIO 46 ‚Üí GPIO 47 (evita strapping)
    -DTOUCH_CS=21
    -DTOUCH_IRQ=47
    
    ; Use HSPI bus on ESP32-S3
    -DUSE_HSPI_PORT
    
    ; SPI Frequencies - conservative values for stability
    ; üîí v2.8.1: Reduced from 27MHz to 20MHz for better stability in release mode
    ; Some ST7796S displays have timing issues at higher frequencies with -Os optimization
    -DSPI_FREQUENCY=20000000       ; 20MHz para TFT (m√°s estable en modo release)
    -DSPI_READ_FREQUENCY=10000000  ; 10MHz para lecturas (reducido para estabilidad)
    -DSPI_TOUCH_FREQUENCY=2500000  ; 2.5MHz para touch (m√°s estable)

    ; ‚úÖ v2.3.0: Configuraci√≥n I2C optimizada (pines actualizados)
    -DWIRE_HAS_TIMEOUT
    -DI2C_SDA=8
    -DI2C_SCL=9
    -DI2C_FREQUENCY=400000
    
    ; ‚úÖ A√ëADIDO: Configuraci√≥n PWM para ESP32-S3
    -DLEDC_TIMER_RESOLUTION=10  ; 10-bit resolution para PWM
    -DLEDC_BASE_FREQ=5000       ; 5kHz base frequency
    
    ; üîß Suprimir warnings de librer√≠as externas
    -w
    -Wno-unused-variable
    -Wno-unused-function
    -Wno-unknown-pragmas
    -Wno-macro-redefined
    -Wno-deprecated-declarations
    
    ; ‚úÖ MEJORADO: Configuraci√≥n de modo standalone con timeout
    ; Descomenta para modo test de pantalla standalone
    ; -DSTANDALONE_DISPLAY
    ; -DSTANDALONE_TIMEOUT=30000  ; 30 segundos timeout

; ===================================================================
; ‚úÖ NUEVO: Entorno de producci√≥n sin debug para mejor performance
; ===================================================================
[env:esp32-s3-devkitc-release]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DCORE_DEBUG_LEVEL=0        ; Sin debug en producci√≥n
    -Os                         ; Optimizaci√≥n de tama√±o
    -DNDEBUG                    ; Desactivar asserts
    ; Comentado el modo standalone para producci√≥n
    ; -DSTANDALONE_DISPLAY

; ===================================================================
; ‚úÖ NUEVO: Entorno para OTA (Over-The-Air updates)
; ===================================================================
[env:esp32-s3-devkitc-ota]
extends = env:esp32-s3-devkitc
upload_protocol = espota
upload_port = 192.168.1.100     ; IP del ESP32 en tu red WiFi
upload_flags = 
    --port=3232
    --auth=your_ota_password     ; Cambiar por tu password OTA
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DENABLE_OTA
    -DOTA_PASSWORD=\"your_ota_password\"
    -DWIFI_SSID=\"your_wifi_ssid\"
    -DWIFI_PASSWORD=\"your_wifi_password\"

; ===================================================================
; ‚úÖ NUEVO: Configuraciones espec√≠ficas para testing
; ===================================================================
[env:esp32-s3-devkitc-test]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DCORE_DEBUG_LEVEL=5        ; M√°ximo debug para testing
    -DTEST_MODE                 ; Activar modo test
    -DSTANDALONE_DISPLAY        ; Modo standalone para test pantalla
    -DTEST_ALL_LEDS            ; Test de todas las LEDs
    -DTEST_ALL_SENSORS         ; Test de todos los sensores