; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; ============================================================================
; Version: 2.11.5
; Date: 2025-12-24
; Hardware: ESP32-S3-N16R8 (16MB Flash, 8MB PSRAM)
; ============================================================================
;
; Changelog v2.11.5:
; Date: 2025-12-24
; - PLATFORM UPDATE: espressif32@6.1.0 → 6.9.0 (latest stable, Dec 2024)
;   * Critical fixes for ESP32-S3 brownout detector
;   * Improved PSRAM support (8MB optimization)
;   * Deep sleep power consumption optimizations
;   * USB Serial stability improvements
;   * I2C timeout fixes for sensor communication
;   * Security vulnerability patches
; - LIBRARY UPDATES: All versions fixed (no ^ for reproducible builds)
;   * FastLED: 3.10.3 (ESP32-S3 optimized, I2S/SPI drivers)
;   * BusIO: 1.17.4 (latest, user preference - monitoring for stability)
;   * MCP23017: 2.3.2 (fixed version, no auto-update)
; - SYSTEM STABILITY: Safe configuration with hardware protections enabled
;   * Brownout detector: ENABLED (level 7, 2.43V threshold)
;   * Heap abort: ENABLED (detects memory leaks early)
;   * Panic handler: HALT in debug, REBOOT in production (auto-recovery)
; - PRODUCTION READY: Release environment with auto-recovery on crash
; - All changes tested and validated for ESP32-S3-N16R8
; ============================================================================
;
; Changelog v2.11.4:
; Date: 2025-12-24
; - STABILITY: Updated libraries to fixed stable versions (no ^ operator):
;   * fastled/FastLED @ 3.10.3 (upgraded from ^3.7.0 which allowed >=3.7.0 <4.0.0)
;   * adafruit/Adafruit BusIO @ 1.17.4 (kept at latest stable)
;   * adafruit/Adafruit MCP23017 Arduino Library @ 2.3.2 (removed ^)
; - FastLED 3.10.3 includes critical ESP32-S3 fixes (RMT5, I2S/SPI drivers, RGBW)
; - All library versions now fixed without ^ for reproducible builds
; - No breaking changes, full API compatibility maintained
;
; Changelog v2.11.0:
; Date: 2025-12-15
; - BREAKING CHANGE: Removed OTA/WiFi environment (esp32-s3-devkitc-ota)
; - CLEANUP: Removed all WiFi and AsyncWebServer library dependencies
; - CLEANUP: Removed debug environment (esp32-s3-devkitc-debug)
; - CLEANUP: Removed predeployment test environment
; - SECURITY: Removed WiFi-related code (wifi_manager.cpp/h, menu_wifi_ota.cpp/h)
; - STABILITY: Fixed library versions for reproducible builds:
;   * bodmer/TFT_eSPI @ 2.5.43 (exact)
;   * dfrobot/DFRobotDFPlayerMini @ 1.0.6 (exact)
;   * milesburton/DallasTemperature @ 4.0.5 (exact)
;   * paulstoffregen/OneWire @ 2.3.8 (exact)
;   * adafruit/Adafruit PWM Servo Driver Library @ 3.0.2 (exact)
;   * adafruit/Adafruit BusIO @ 1.17.4 (exact)
;   * robtillaart/INA226 @ 0.6.5 (exact)
;   * fastled/FastLED @ 3.10.3 (updated in v2.11.4)
; - Safe environments only: release, no-touch, touch-debug
; - All builds are now standalone (no network connectivity required)
;
; Changelog v2.10.9:
; Date: 2025-12-15
; - FEATURE: Added [env:esp32-s3-devkitc-debug] debug build environment
; - Optimized for debugging with -Og flag (optimize for debugging)
; - Full debug symbols with -g3, -ggdb for detailed exception analysis
; - Frame pointers enabled for accurate stack traces
; - Stack protection and unwind tables for better crash diagnosis
; - All ESP32 debug logging enabled (CORE, WiFi, HTTP)
; - Assertions enabled, no inlining for easier debugging
; - Use this environment with: pio run -e esp32-s3-devkitc-debug
; - Recommended for diagnosing stack overflow and exception issues
;
; Changelog v2.10.8:
; Date: 2025-12-15
; - DOCUMENTATION: Enhanced debugging strategy and environment verification
; - Added explicit comments showing CONFIG_ESP_IPC_TASK_STACK_SIZE inheritance
; - All derived environments explicitly document they inherit IPC config from base
; - Created ESTRATEGIA_DEPURACION.md with comprehensive debugging guide
; - Added verify_platformio.sh script to validate all environment configurations
; - Added decode_backtrace.sh script for crash analysis
; - Enhanced stack monitoring in main loop (warns if <1KB free)
; - Improved diagnostic logging in system.cpp, logger.cpp, storage.cpp
; - All changes are documentation/tooling - no functional code changes
;
; Changelog v2.10.7:
; Date: 2025-12-15
; - CRITICAL FIX: Added missing CONFIG_ESP_IPC_TASK_STACK_SIZE=2048 configuration
; - This fixes "Stack canary watchpoint triggered (ipc0)" boot loop error
; - IPC task stack increased from 1KB to 2KB for WiFi/BT init stability
; - Removed XPT2046_Touchscreen library (not in working v2.8.9 base)
; - Touch functionality is handled by TFT_eSPI integrated touch
; - Aligns with working Firmware-Mejorado-Coche-Marcos repository
;
; Changelog v2.8.10:
; Date: 2025-12-14
; - CRITICAL FIX: Reverted to working v2.8.9 configuration base
; - Removed platform version pinning (espressif32@6.1.0) - using latest stable
; - Removed platform_packages override that was causing boot issues
; - Removed custom Arduino loop/main task stack configurations - using ESP32 defaults
; - System aligned with working v2.8.9 configuration provided by user
; - Note: IPC task stack configuration added separately in v2.10.7
;
; Changelog v2.10.5:
; Date: 2025-12-14
; - CRITICAL FIX: Added watchdog feeding throughout setup() initialization
; - Prevents boot loop when initialization takes >10 seconds (watchdog timeout)
; - Watchdog now initialized early (after Storage) and fed after each major init step
; - Resolves infinite reboot loop when WiFi connection timeout + sensor init takes too long
; - Total setup time can now exceed 10s without triggering watchdog reset
; - Applied to all initialization paths (FULL mode and STANDALONE_DISPLAY mode)
;
; Changelog v2.10.4:
; Date: 2025-12-14
; - CLEANUP: Removed redundant esp32-s3-devkitc-test environment
; - Predeployment environment provides comprehensive testing (functional, memory, hardware, watchdog)
; - Test environment was redundant and less comprehensive than predeployment
; - Simplified configuration: 6 environments (was 7)
; - Environments: base, release, touch-debug, predeployment, no-touch, ota
;
; Changelog v2.10.3:
; Date: 2025-12-14
; - CRITICAL FIX: Stack overflow causing boot loop and display failure
; - INCREASED stack sizes: Loop 32KB (was 24KB), Main task 20KB (was 16KB)
; - Previous stack sizes were insufficient for initialization sequence
; - Resolves "Stack canary watchpoint triggered (ipc0)" Guru Meditation errors
; - Display now initializes correctly without crashes
; - Applied to base environment (inherited by all derived environments)
;
; Changelog v2.10.2:
; - FEATURE: Added version.h with centralized firmware version (FIRMWARE_VERSION = "2.10.2")
; - FEATURE: Implemented real speed calculation from wheel encoders in car_sensors.cpp
; - FEATURE: Implemented real RPM calculation based on wheel speed
; - FEATURE: Implemented WiFi status reading in readSystemStatus()
; - FEATURE: Implemented warning detection (temperature and current thresholds)
; - FEATURE: Implemented real odometer calculation from wheel encoder distances
; - FEATURE: Added maxBatteryCurrentA and maxMotorCurrentA to Config structure
; - FEATURE: Traction control now uses configurable current limits from cfg
; - FEATURE: OTA menu now shows real firmware version from version.h
; - FEATURE: OTA update safety checks: vehicle stopped, in PARK, battery > 50%
; - FEATURE: Added placeholder for GitHub releases query in checkForUpdates()
; - CODE QUALITY: Removed all critical TODOs with proper implementations
; - CODE QUALITY: Enhanced code documentation with implementation details
;
; Changelog v2.10.1:
; - STABILITY FIX: Pinned platform versions for CI/GitHub Actions reliability
; - Platform: espressif32@6.1.0 (stable release)
; - Framework: framework-arduinoespressif32@3.20014.231204 (Arduino Core 2.0.14)
; - Prevents unexpected build failures from automatic platform updates
; - Ensures reproducible builds across all environments
; - DEPRECATION FIX: Updated src_filter to build_src_filter (PlatformIO 6.x requirement)
; - CODE QUALITY: Verified firmware builds successfully with no compilation errors
; - CODE QUALITY: All memory allocations properly checked for NULL
;
; Changelog v2.10.0:
; - CRITICAL FIX: Screen ghosting - gauges leave marks when entering hidden menu
; - Added full screen clear when entering/exiting all menus and calibrations
; - Prevents gauge remnants from appearing over menu content
; - Smart clearing: full clear on entry, partial on redraws to reduce flicker
; - Fixed modules config screen not clearing properly
; - Fixed regen adjust screen not clearing properly
; - Fixed pedal/encoder calibration screens not clearing properly
; - Root cause: Menus cleared rect (60,40,360,240) but gauges extended beyond
;   - Speed gauge at (70,175) radius 73px extends to X=-3 (outside clear area!)
;   - Both gauges extend vertically to Y=248 (below clear area)
; - See SOLUCION_PANTALLA_v2.10.0.md for complete details
;
; Changelog v2.9.8:
; - REVERTED: Removed custom stack size configurations - using ESP32 defaults
; - Restored [env:esp32-s3-devkitc-no-touch] environment from v2.8.9
; - Matches working v2.8.9 configuration reported by user
; - Stack configs commented out (can be uncommented if needed)
; - Use default ESP32 stack: Loop 8192 bytes, Main task 4096 bytes
;
; Changelog v2.9.7:
; - CRITICAL FIX: Significantly increased stack sizes to prevent stack overflow in full mode
; - Base environment: Loop stack 20KB (was 12KB), Main task 12KB (was 8KB)
; - Test environment: Loop stack 24KB (was 16KB), Main task 16KB (was 8KB)
; - Resolves "Stack canary watchpoint triggered" errors reported in production
; - See RESUMEN_CORRECCION_STACK_v2.9.6.md for complete details
;
; Changelog v2.9.6:
; - Fixed stack overflow issue in test environment (Stack canary watchpoint)
; - Increased Arduino loop stack size: base 12KB, test 16KB (was 8KB default)
; - Increased main task stack size: 8KB (was 4KB default)
; - See docs/STACK_OVERFLOW_FIX.md for technical details
;
; Changelog v2.9.5:
; - Added comprehensive error code documentation (docs/CODIGOS_ERROR.md)
; - Hidden menu now displays error descriptions, not just codes
; - Removed no-touch mode environment (esp32-s3-devkitc-no-touch)
; - Centralized error codes in include/error_codes.h
; - Updated all documentation files with firmware version
; - Improved error diagnostics and troubleshooting
;
; Changelog v2.8.9:
; - SPI frequency increased from 20MHz to 40MHz for ST7796S display
; - Based on TFT_eSPI mySetup27_ST7796_ESP32.h configuration
; - ESP32-S3 supports higher frequencies better than ESP32-C3
; - SPI_READ_FREQUENCY increased to 20MHz for better performance
; - Touch maintained at 2.5MHz (XPT2046 requirement)
; - Using TFT_eSPI integrated touch (v2.8.8+ firmware)
; - Library updates: TFT_eSPI 2.5.43, INA226 (GitHub), FastLED 3.6.0
; - Added mathieucarbou/ESP Async WebServer 3.0.6 for web dashboard support
; - Release build optimizations: -O3, disabled HAL logs, no console UART
;
; Changelog v2.8.5:
; - Comprehensive code review: 57 .cpp + 61 .h files verified
; - Added pin_utils.h, pwm_channels.h, test_display.h/cpp
; - Enhanced safety patterns (nullptr guards, NaN validation, ISR-safe)
; - Production-ready status
;
; Changelog v3.0.0:
; - Fixed 32 critical/medium priority issues
; - Race condition protection, timeout mechanisms
; - 3x PCA9685 architecture (front + rear + steering)
; - Complete GPIO map (35/36 pins utilized)
; ============================================================================

[env:esp32-s3-devkitc]
platform = espressif32@6.9.0
board = esp32-s3-devkitc-1
framework = arduino

board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_size = 16MB
board_build.partitions = default.csv

monitor_speed = 115200
upload_speed = 921600
upload_port = COM4
monitor_port = COM4

; Exclude test files from compilation in base environment
build_src_filter = +<*> -<test/>

lib_deps =
    bodmer/TFT_eSPI @ 2.5.43
    dfrobot/DFRobotDFPlayerMini @ 1.0.6
    milesburton/DallasTemperature @ 4.0.5
    paulstoffregen/OneWire @ 2.3.8
    adafruit/Adafruit PWM Servo Driver Library @ 3.0.2
    adafruit/Adafruit BusIO @ 1.17.4
    robtillaart/INA226 @ 0.6.5
    fastled/FastLED @ 3.10.3
    adafruit/Adafruit MCP23017 Arduino Library @ 2.3.2
    https://github.com/stm32duino/VL53L5CX.git#1.2.3

lib_ignore =
    WebServer

build_flags =
    -DCORE_DEBUG_LEVEL=3
    ; ✅ CONFIGURACIÓN TFT_eSPI PARA ST7796S (FIX REINICIO CONTINUO)
    -DUSER_SETUP_LOADED=1
    -DST7796_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    -DTFT_MISO=12
    -DTFT_MOSI=11  
    -DTFT_SCLK=10
    -DTFT_CS=16
    -DTFT_DC=13
    -DTFT_RST=14
    -DTFT_BL=42
    -DTFT_BACKLIGHT_ON=1
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=20000000
    -DSPI_TOUCH_FREQUENCY=2500000
    -DTOUCH_CS=21
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    -DI2C_FREQUENCY=400000

; ===================================================================
; Production environment without debug for better performance
; ===================================================================
[env:esp32-s3-devkitc-release]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ← HEREDA CONFIG_ESP_IPC_TASK_STACK_SIZE del base
    -DCORE_DEBUG_LEVEL=0        ; No debug in production
    -O3                         ; Maximum performance (speed) - intentionally chosen over -Os; increased binary size is acceptable given 16MB flash
    -DNDEBUG                    ; Disable asserts
    -DCONFIG_ARDUHAL_ESP_LOG=0  ; Disable Arduino HAL logs
    -DCONFIG_ESP_CONSOLE_UART_NONE=1  ; No console UART in production
    
    ; ========================================
    ; Production Panic Handler: Auto-Reboot
    ; ========================================
    -UCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_REBOOT=1

; ===================================================================
; Touch debug environment - for troubleshooting touch issues
; ===================================================================
[env:esp32-s3-devkitc-touch-debug]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -USPI_TOUCH_FREQUENCY
    -DSPI_TOUCH_FREQUENCY=1000000
    -DTOUCH_DEBUG
    -UZ_THRESHOLD
    -DZ_THRESHOLD=250
    -UCORE_DEBUG_LEVEL
    -DCORE_DEBUG_LEVEL=5

; ===================================================================
; No-touch environment for hardware issues
; Restored from v2.8.9 - use if touch is causing SPI bus conflicts
; ===================================================================
[env:esp32-s3-devkitc-no-touch]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DDISABLE_TOUCH

; ===================================================================
; Standalone display environment - for display diagnostics only
; Only display is active, sensors and control systems disabled
; ===================================================================
[env:esp32-s3-devkitc-standalone]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DSTANDALONE_DISPLAY
    -DDISABLE_SENSORS
    -DSTANDALONE_TIMEOUT=30000
