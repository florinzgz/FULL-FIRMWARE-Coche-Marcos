; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; ============================================================================
; Version: 2.11.5-FIXED
; Hardware actual: ESP32-S3-WROOM-2 N32R16V (32MB Flash, 16MB PSRAM)
; ============================================================================

[env:esp32-s3-devkitc1]
platform = espressif32@6.12.0
board = esp32-s3-devkitc-1
framework = arduino

board_build.mcu = esp32s3
board_build.f_cpu = 240000000L

; ---- MEMORIA ----
board_build.flash_size = 32MB
board_build.psram = enabled
board_build.psram_size = 16MB
board_build.partitions = huge_app.csv

monitor_speed = 115200
upload_speed = 921600
upload_port = COM4
monitor_port = COM4

build_src_filter = +<*> -<test/>
extra_scripts = pre:install_deps.py

; ================= LIBRERÍAS =================
lib_deps =
    bodmer/TFT_eSPI @ 2.5.43
    dfrobot/DFRobotDFPlayerMini @ 1.0.6
    milesburton/DallasTemperature @ 3.11.0
    paulstoffregen/OneWire @ 2.3.8
    adafruit/Adafruit PWM Servo Driver Library @ 3.0.2
    adafruit/Adafruit BusIO @ 1.17.4
    robtillaart/INA226 @ 0.6.5
    fastled/FastLED @ 3.10.3
    adafruit/Adafruit MCP23017 Arduino Library @ 2.3.2
    sparkfun/SparkFun VL53L5CX Arduino Library @ 1.0.3
    https://github.com/WifWaf/TCA9548A

lib_ignore =
    WebServer

; ================= FLAGS =================
build_flags =
    ; ---- PSRAM ----
    -DBOARD_HAS_PSRAM

    ; ---- STACK / SEGURIDAD ----
    -DCONFIG_ARDUINO_LOOP_STACK_SIZE=32768
    -DCONFIG_ARDUINO_TASK_STACK_SIZE=20480
    -DCONFIG_ESP_IPC_TASK_STACK_SIZE=4096
    -DCONFIG_ESP_MAIN_TASK_STACK_SIZE=16384

    ; ---- BROWNOUT ----
    -DCONFIG_ESP_BROWNOUT_DET=1
    -DCONFIG_ESP_BROWNOUT_DET_LVL=ESP_BROWNOUT_DET_LVL7_2V43

    ; ---- PANIC ----
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT=1
    -UCONFIG_ESP_SYSTEM_PANIC_PRINT_REBOOT

    ; ---- WATCHDOG ----
    -DCONFIG_ESP_TASK_WDT_EN=1
    -DCONFIG_ESP_TASK_WDT_TIMEOUT_S=30
    -DCONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU0=1
    -DCONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU1=1

    ; ---- HEAP EXTRA ----
    -DCONFIG_ESP_SYSTEM_ALLOW_RTC_FAST_MEM_AS_HEAP=1

    ; ---- DEBUG ----
    -DCORE_DEBUG_LEVEL=3

    ; ---- TFT_eSPI ----
    -DUSER_SETUP_LOADED=1
    -DST7796_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    -DTFT_MISO=12
    -DTFT_MOSI=11
    -DTFT_SCLK=10
    -DTFT_CS=16
    -DTFT_DC=13
    -DTFT_RST=14
    -DTFT_BL=42
    -DTFT_BACKLIGHT_ON=1
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=20000000
    -DSPI_TOUCH_FREQUENCY=2500000
    -DTOUCH_CS=21
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    -DI2C_FREQUENCY=400000


; ===================================================================
; PRODUCTION — menos logs, más rendimiento
; ===================================================================
[env:esp32-s3-devkitc1-release]
extends = env:esp32-s3-devkitc1
build_flags =
    ${env:esp32-s3-devkitc1.build_flags}
    -DCORE_DEBUG_LEVEL=0
    -O3
    -DNDEBUG
    -DCONFIG_ARDUHAL_ESP_LOG=0
    -DCONFIG_ESP_CONSOLE_UART_NONE=1
    -UCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_REBOOT=1


; ===================================================================
; TOUCH DEBUG — para problemas del táctil
; ===================================================================
[env:esp32-s3-devkitc1-touch-debug]
extends = env:esp32-s3-devkitc1
build_flags =
    ${env:esp32-s3-devkitc1.build_flags}
    -USPI_TOUCH_FREQUENCY
    -DSPI_TOUCH_FREQUENCY=1000000
    -DTOUCH_DEBUG
    -UZ_THRESHOLD
    -DZ_THRESHOLD=250
    -UCORE_DEBUG_LEVEL
    -DCORE_DEBUG_LEVEL=5


; ===================================================================
; NO TOUCH — si el táctil bloquea el SPI
; ===================================================================
[env:esp32-s3-devkitc1-no-touch]
extends = env:esp32-s3-devkitc1
build_flags =
    ${env:esp32-s3-devkitc1.build_flags}
    -DDISABLE_TOUCH


; ===================================================================
; STANDALONE DISPLAY — diagnosticar solo pantalla
; ===================================================================
[env:esp32-s3-devkitc1-standalone]
extends = env:esp32-s3-devkitc1
build_flags =
    ${env:esp32-s3-devkitc1.build_flags}
    -DSTANDALONE_DISPLAY
    -DDISABLE_SENSORS
    -DSTANDALONE_TIMEOUT=30000


; ===================================================================
; ADVANCED — Generación automática de compile_commands.json
; ===================================================================
[advanced]
compile_commands = yes
