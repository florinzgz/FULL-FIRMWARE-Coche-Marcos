; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; Hardware: ESP32-S3 DevKitC-1 N16R8 (16MB Flash QIO + 8MB PSRAM QSPI)
; Flash: 16MB QIO @ 80MHz
; PSRAM: 8MB QSPI (Quad SPI) @ 80MHz
; ============================================================================

[platformio]
boards_dir = boards
default_envs = esp32-s3-devkitc1-n16r8

; ===================================================================
; ACTIVE BOARD: ESP32-S3-DevKitC-1-N16R8
; Custom board manifest with proper USB Serial configuration
; ===================================================================
[env:esp32-s3-devkitc1-n16r8]
platform = espressif32
board = esp32-s3-devkitc1-n16r8
framework = arduino
build_type = debug

monitor_speed = 115200
monitor_filters = esp32_exception_decoder
monitor_rts = 0
monitor_dtr = 0

upload_speed = 921600
upload_port = COM3
monitor_port = COM3

; ================= Stack Size Configuration =================
board_build.arduino.loop_stack_size = 32768
board_build.arduino.event_stack_size = 16384

; ================= SDK Configuration =================
; ðŸ”’ v2.18.2: Critical bootloop fix - loads increased watchdog timeouts
; Reference: BOOTLOOP_STATUS_2026-01-18.md
board_build.sdkconfig = sdkconfig/n16r8.defaults

; ================= Build Scripts =================
extra_scripts =
    pre:install_deps.py
    pre:tools/patch_arduino_sdkconfig.py
    pre:tools/preflight_validator.py

; ================= LIBRARIES =================
lib_deps =
    bodmer/TFT_eSPI @ 2.5.43
    dfrobot/DFRobotDFPlayerMini @ 1.0.6
    milesburton/DallasTemperature @ 3.11.0
    paulstoffregen/OneWire @ 2.3.8
    adafruit/Adafruit PWM Servo Driver Library @ 3.0.2
    adafruit/Adafruit BusIO @ 1.17.4
    robtillaart/INA226 @ 0.6.5
    fastled/FastLED @ 3.10.3
    adafruit/Adafruit MCP23017 Arduino Library @ 2.3.2
    https://github.com/WifWaf/TCA9548A

lib_ignore =
    WebServer

; ================= FLAGS =================
build_flags =
    -DCORE_DEBUG_LEVEL=5
    
    ; ðŸ”’ v2.18.2: PSRAM Configuration restored
    ; Based on BOOTLOOP_STATUS_2026-01-18.md: bootloop was RESOLVED with PSRAM enabled
    ; using increased watchdog timeouts (3000ms), NOT by disabling PSRAM
    ; Hardware: ESP32-S3 N16R8 has 8MB PSRAM QSPI @ 80MHz (Quad SPI mode)
    ; PSRAM provides memory for FreeRTOS tasks (v2.18.0 multitasking architecture)
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=0

    ; ---- TFT_eSPI ----
    -DUSER_SETUP_LOADED=1
    -DST7796_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    -DTFT_MISO=12
    -DTFT_MOSI=11
    -DTFT_SCLK=10
    -DTFT_CS=16
    -DTFT_DC=13
    -DTFT_RST=14
    -DTFT_BL=42
    -DTFT_BACKLIGHT_ON=1
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=20000000
    -DSPI_TOUCH_FREQUENCY=2500000
    -DTOUCH_CS=21
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    -DI2C_FREQUENCY=400000
