; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; ============================================================================
; Version: 2.10.8
; Date: 2025-12-15
; Hardware: ESP32-S3-DevKitC-1 (44 pines)
; ============================================================================
; 
; Changelog v2.10.8:
; Date: 2025-12-15
; - DOCUMENTATION: Enhanced debugging strategy and environment verification
; - Added explicit comments showing CONFIG_ESP_IPC_TASK_STACK_SIZE inheritance
; - All derived environments explicitly document they inherit IPC config from base
; - Created ESTRATEGIA_DEPURACION.md with comprehensive debugging guide
; - Added verify_platformio.sh script to validate all environment configurations
; - Added decode_backtrace.sh script for crash analysis
; - Enhanced stack monitoring in main loop (warns if <1KB free)
; - Improved diagnostic logging in system.cpp, logger.cpp, storage.cpp
; - All changes are documentation/tooling - no functional code changes
;
; Changelog v2.10.7:
; Date: 2025-12-15
; - CRITICAL FIX: Added missing CONFIG_ESP_IPC_TASK_STACK_SIZE=2048 configuration
; - This fixes "Stack canary watchpoint triggered (ipc0)" boot loop error
; - IPC task stack increased from 1KB to 2KB for WiFi/BT init stability
; - Removed XPT2046_Touchscreen library (not in working v2.8.9 base)
; - Touch functionality is handled by TFT_eSPI integrated touch
; - Aligns with working Firmware-Mejorado-Coche-Marcos repository
;
; Changelog v2.8.10:
; Date: 2025-12-14
; - CRITICAL FIX: Reverted to working v2.8.9 configuration base
; - Removed platform version pinning (espressif32@6.1.0) - using latest stable
; - Removed platform_packages override that was causing boot issues
; - Removed custom Arduino loop/main task stack configurations - using ESP32 defaults
; - System aligned with working v2.8.9 configuration provided by user
; - Note: IPC task stack configuration added separately in v2.10.7
;
; Changelog v2.10.5:
; Date: 2025-12-14
; - CRITICAL FIX: Added watchdog feeding throughout setup() initialization
; - Prevents boot loop when initialization takes >10 seconds (watchdog timeout)
; - Watchdog now initialized early (after Storage) and fed after each major init step
; - Resolves infinite reboot loop when WiFi connection timeout + sensor init takes too long
; - Total setup time can now exceed 10s without triggering watchdog reset
; - Applied to all initialization paths (FULL mode and STANDALONE_DISPLAY mode)
;
; Changelog v2.10.4:
; Date: 2025-12-14
; - CLEANUP: Removed redundant esp32-s3-devkitc-test environment
; - Predeployment environment provides comprehensive testing (functional, memory, hardware, watchdog)
; - Test environment was redundant and less comprehensive than predeployment
; - Simplified configuration: 6 environments (was 7)
; - Environments: base, release, touch-debug, predeployment, no-touch, ota
;
; Changelog v2.10.3:
; Date: 2025-12-14
; - CRITICAL FIX: Stack overflow causing boot loop and display failure
; - INCREASED stack sizes: Loop 32KB (was 24KB), Main task 20KB (was 16KB)
; - Previous stack sizes were insufficient for initialization sequence
; - Resolves "Stack canary watchpoint triggered (ipc0)" Guru Meditation errors
; - Display now initializes correctly without crashes
; - Applied to base environment (inherited by all derived environments)
;
; Changelog v2.10.2:
; - FEATURE: Added version.h with centralized firmware version (FIRMWARE_VERSION = "2.10.2")
; - FEATURE: Implemented real speed calculation from wheel encoders in car_sensors.cpp
; - FEATURE: Implemented real RPM calculation based on wheel speed
; - FEATURE: Implemented WiFi status reading in readSystemStatus()
; - FEATURE: Implemented warning detection (temperature and current thresholds)
; - FEATURE: Implemented real odometer calculation from wheel encoder distances
; - FEATURE: Added maxBatteryCurrentA and maxMotorCurrentA to Config structure
; - FEATURE: Traction control now uses configurable current limits from cfg
; - FEATURE: OTA menu now shows real firmware version from version.h
; - FEATURE: OTA update safety checks: vehicle stopped, in PARK, battery > 50%
; - FEATURE: Added placeholder for GitHub releases query in checkForUpdates()
; - CODE QUALITY: Removed all critical TODOs with proper implementations
; - CODE QUALITY: Enhanced code documentation with implementation details
;
; Changelog v2.10.1:
; - STABILITY FIX: Pinned platform versions for CI/GitHub Actions reliability
; - Platform: espressif32@6.1.0 (stable release)
; - Framework: framework-arduinoespressif32@3.20014.231204 (Arduino Core 2.0.14)
; - Prevents unexpected build failures from automatic platform updates
; - Ensures reproducible builds across all environments
; - DEPRECATION FIX: Updated src_filter to build_src_filter (PlatformIO 6.x requirement)
; - CODE QUALITY: Verified firmware builds successfully with no compilation errors
; - CODE QUALITY: All memory allocations properly checked for NULL
;
; Changelog v2.10.0:
; - CRITICAL FIX: Screen ghosting - gauges leave marks when entering hidden menu
; - Added full screen clear when entering/exiting all menus and calibrations
; - Prevents gauge remnants from appearing over menu content
; - Smart clearing: full clear on entry, partial on redraws to reduce flicker
; - Fixed modules config screen not clearing properly
; - Fixed regen adjust screen not clearing properly
; - Fixed pedal/encoder calibration screens not clearing properly
; - Root cause: Menus cleared rect (60,40,360,240) but gauges extended beyond
;   - Speed gauge at (70,175) radius 73px extends to X=-3 (outside clear area!)
;   - Both gauges extend vertically to Y=248 (below clear area)
; - See SOLUCION_PANTALLA_v2.10.0.md for complete details
;
; Changelog v2.9.8:
; - REVERTED: Removed custom stack size configurations - using ESP32 defaults
; - Restored [env:esp32-s3-devkitc-no-touch] environment from v2.8.9
; - Matches working v2.8.9 configuration reported by user
; - Stack configs commented out (can be uncommented if needed)
; - Use default ESP32 stack: Loop 8192 bytes, Main task 4096 bytes
;
; Changelog v2.9.7:
; - CRITICAL FIX: Significantly increased stack sizes to prevent stack overflow in full mode
; - Base environment: Loop stack 20KB (was 12KB), Main task 12KB (was 8KB)
; - Test environment: Loop stack 24KB (was 16KB), Main task 16KB (was 8KB)
; - Resolves "Stack canary watchpoint triggered" errors reported in production
; - See RESUMEN_CORRECCION_STACK_v2.9.6.md for complete details
;
; Changelog v2.9.6:
; - Fixed stack overflow issue in test environment (Stack canary watchpoint)
; - Increased Arduino loop stack size: base 12KB, test 16KB (was 8KB default)
; - Increased main task stack size: 8KB (was 4KB default)
; - See docs/STACK_OVERFLOW_FIX.md for technical details
;
; Changelog v2.9.5:
; - Added comprehensive error code documentation (docs/CODIGOS_ERROR.md)
; - Hidden menu now displays error descriptions, not just codes
; - Removed no-touch mode environment (esp32-s3-devkitc-no-touch)
; - Centralized error codes in include/error_codes.h
; - Updated all documentation files with firmware version
; - Improved error diagnostics and troubleshooting
;
; Changelog v2.8.9:
; - SPI frequency increased from 20MHz to 40MHz for ST7796S display
; - Based on TFT_eSPI mySetup27_ST7796_ESP32.h configuration
; - ESP32-S3 supports higher frequencies better than ESP32-C3
; - SPI_READ_FREQUENCY increased to 20MHz for better performance
; - Touch maintained at 2.5MHz (XPT2046 requirement)
; - Using TFT_eSPI integrated touch (v2.8.8+ firmware)
; - Library updates: TFT_eSPI 2.5.43, INA226 (GitHub), FastLED 3.6.0
; - Added mathieucarbou/ESP Async WebServer 3.0.6 for web dashboard support
; - Release build optimizations: -O3, disabled HAL logs, no console UART
;
; Changelog v2.8.5:
; - Comprehensive code review: 57 .cpp + 61 .h files verified
; - Added pin_utils.h, pwm_channels.h, test_display.h/cpp
; - Enhanced safety patterns (nullptr guards, NaN validation, ISR-safe)
; - Production-ready status
;
; Changelog v3.0.0:
; - Fixed 32 critical/medium priority issues
; - Race condition protection, timeout mechanisms
; - 3x PCA9685 architecture (front + rear + steering)
; - Complete GPIO map (35/36 pins utilized)
; ============================================================================

[env:esp32-s3-devkitc]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_size = 16MB
board_build.partitions = default.csv

monitor_speed = 115200
upload_speed = 921600
upload_port = COM4
monitor_port = COM4

; Exclude test files from compilation in base environment
build_src_filter = +<*> -<test/>

lib_deps =
    bodmer/TFT_eSPI @ ^2.5.43
    dfrobot/DFRobotDFPlayerMini @ ^1.0.6
    milesburton/DallasTemperature@^4.0.5
    paulstoffregen/OneWire@^2.3.8
    https://github.com/adafruit/Adafruit-PWM-Servo-Driver-Library.git
    https://github.com/RobTillaart/INA226
    fastled/FastLED @ ^3.6.0
    adafruit/Adafruit MCP23017 Arduino Library @ ^2.3.2
    https://github.com/stm32duino/VL53L5CX.git#1.2.3
    mathieucarbou/ESP Async WebServer @ ^3.0.6
    mathieucarbou/AsyncTCP @ ^3.1.4

lib_ignore =
    WebServer

build_flags =
    -DCORE_DEBUG_LEVEL=5
    -DUSER_SETUP_LOADED
    -std=gnu++17
    -DLOAD_GLCD
    -DLOAD_FONT2
    -DLOAD_FONT4
    -DLOAD_FONT6
    -DLOAD_FONT7
    -DLOAD_FONT8
    -DSMOOTH_FONT
    -Iinclude
    
    ; ========================================
    ; TFT_eSPI configuration for ST7796S (480x320)
    ; ESP32-S3-N16R8 with HSPI
    ; Pin assignments must match pins.h
    ; ========================================
    -DST7796_DRIVER
    ; CRITICAL: TFT_WIDTH/HEIGHT are NATIVE dimensions BEFORE rotation
    ; ST7796S native orientation is portrait (320x480)
    ; With setRotation(3), display becomes landscape (480x320)
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    
    ; Pin mapping TFT (must match pins.h)
    -DTFT_CS=16
    -DTFT_DC=13
    -DTFT_RST=14
    -DTFT_MOSI=11
    -DTFT_MISO=12
    -DTFT_SCLK=10
    -DTFT_BL=42
    
    ; Touch pins (XPT2046) - integrated with TFT_eSPI (v2.8.8+)
    -DTOUCH_CS=21
    ; Note: TOUCH_IRQ is NOT used by TFT_eSPI library (uses polling mode)
    ; The library does not require IRQ pin for touch detection
    ; IRQ pin can be left unconnected if using TFT_eSPI touch functions
    ; If you want to use interrupt-based touch with a different library,
    ; uncomment the line below and implement separate IRQ handler
    ; -DTOUCH_IRQ=47
    
    ; Use HSPI bus on ESP32-S3
    -DUSE_HSPI_PORT
    
    ; SPI Frequencies - optimized for ST7796S on ESP32-S3
    ; v2.8.9: 40MHz based on TFT_eSPI recommendation for ST7796
    ; ESP32-S3 handles higher frequencies well
    -DSPI_FREQUENCY=40000000       ; 40MHz for TFT (recommended for ST7796S)
    -DSPI_READ_FREQUENCY=20000000  ; 20MHz for read operations
    -DSPI_TOUCH_FREQUENCY=2500000  ; 2.5MHz for touch (XPT2046 typical)
    ; NOTE: If touch is not working, try lowering SPI_TOUCH_FREQUENCY to:
    ;   1000000 (1MHz) for more reliability, or even
    ;   100000 (100kHz) for maximum compatibility (slower but more reliable)
    
    ; Touch controller configuration (XPT2046)
    ; Z_THRESHOLD: Minimum pressure value to register a valid touch
    ; Lower values = more sensitive, higher values = less sensitive
    ; Default is 350, range typically 200-600
    ; v2.9.3: Reduced from 350 to 300 for better touch sensitivity
    -DZ_THRESHOLD=300
    
    ; Touch debug - uncomment to enable verbose touch logging
    ; This will log every touch event and raw values for troubleshooting
    ; -DTOUCH_DEBUG
    
    ; SPI Transaction support for reliable touch/display bus sharing
    -DSPI_HAS_TRANSACTION
    -DSUPPORT_TRANSACTIONS

    ; I2C Configuration
    -DWIRE_HAS_TIMEOUT
    -DI2C_SDA=8
    -DI2C_SCL=9
    -DI2C_FREQUENCY=400000
    
    ; IPC (Inter-Processor Communication) task stack size
    ; v2.10.7: CRITICAL FIX for "Stack canary watchpoint triggered (ipc0)" error
    ; ESP32-S3 default IPC stack (1KB) is too small, causing early boot crash
    ; IPC tasks handle inter-core communication and require adequate stack
    ; Increased from default 1024 bytes to 2048 bytes for stability
    -DCONFIG_ESP_IPC_TASK_STACK_SIZE=2048
    
    ; Arduino Loop and Main Task stack sizes
    ; v2.10.3: CRITICAL FIX for stack overflow causing boot loop
    ; ESP32-S3 defaults (Loop 8KB, Main 4KB) are insufficient for full initialization
    ; Increased to Loop 32KB, Main task 20KB to prevent "Stack canary watchpoint" errors
    ; These values provide adequate stack for WiFi init, sensor init, and display rendering
    -DCONFIG_ARDUINO_LOOP_STACK_SIZE=32768
    -DCONFIG_ESP_MAIN_TASK_STACK_SIZE=20480
    
    ; ‚úÖ A√ëADIDO: Configuraci√≥n PWM para ESP32-S3
    -DLEDC_TIMER_RESOLUTION=10  ; 10-bit resolution para PWM
    -DLEDC_BASE_FREQ=5000       ; 5kHz base frequency
    
    ; üîß Suprimir warnings de librer√≠as externas
    -w
    -Wno-unused-variable
    -Wno-unused-function
    -Wno-unknown-pragmas
    -Wno-macro-redefined
    -Wno-deprecated-declarations
    
    
    ; Standalone display mode (uncomment for display testing)
    ; -DSTANDALONE_DISPLAY
    ; -DSTANDALONE_TIMEOUT=30000  ; 30 seconds timeout

; ===================================================================
; Production environment without debug for better performance
; ===================================================================
[env:esp32-s3-devkitc-release]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ‚Üê HEREDA CONFIG_ESP_IPC_TASK_STACK_SIZE del base
    -DCORE_DEBUG_LEVEL=0        ; No debug in production
    -O3                         ; Maximum performance (speed) - intentionally chosen over -Os; increased binary size is acceptable given 16MB flash
    -DNDEBUG                    ; Disable asserts
    -DCONFIG_ARDUHAL_ESP_LOG=0  ; Disable Arduino HAL logs
    -DCONFIG_ESP_CONSOLE_UART_NONE=1  ; No console UART in production

; ===================================================================
; OTA (Over-The-Air updates) environment
; ===================================================================
[env:esp32-s3-devkitc-ota]
extends = env:esp32-s3-devkitc
upload_protocol = espota
upload_port = 192.168.1.100     ; ESP32 IP address on WiFi network
upload_flags = 
    --port=3232
    --auth=wifimarcos2020
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ‚Üê HEREDA CONFIG_ESP_IPC_TASK_STACK_SIZE del base
    -DENABLE_OTA
    -DOTA_PASSWORD=\"wifimarcos2020\"
    -DWIFI_SSID=\"NOVA\ AW5700\"
    -DWIFI_PASSWORD=\"florinzgz26!\"

; ===================================================================
; Touch debug environment - for troubleshooting touch issues
; ===================================================================
[env:esp32-s3-devkitc-touch-debug]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ‚Üê HEREDA CONFIG_ESP_IPC_TASK_STACK_SIZE del base
    -USPI_TOUCH_FREQUENCY           ; Remove default touch frequency
    -DSPI_TOUCH_FREQUENCY=1000000   ; Use slower 1MHz for better reliability
    -DTOUCH_DEBUG                   ; Enable verbose touch logging
    -UZ_THRESHOLD                   ; Remove default threshold
    -DZ_THRESHOLD=250               ; Use lower threshold (more sensitive)
    -DCORE_DEBUG_LEVEL=5            ; Maximum debug output

; ===================================================================
; Pre-Deployment Testing Environment
; Comprehensive testing before production deployment
; ===================================================================
[env:esp32-s3-devkitc-predeployment]
extends = env:esp32-s3-devkitc

; Include test files in this environment
build_src_filter = +<*>

build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ‚Üê HEREDA CONFIG_ESP_IPC_TASK_STACK_SIZE del base
    -DCORE_DEBUG_LEVEL=5            ; Maximum debug for comprehensive logging
    -DTEST_MODE                     ; Enable test mode
    -DENABLE_FUNCTIONAL_TESTS       ; Enable functional testing module
    -DENABLE_MEMORY_STRESS_TESTS    ; Enable memory stress testing
    -DENABLE_HARDWARE_FAILURE_TESTS ; Enable hardware failure scenario testing
    -DENABLE_WATCHDOG_TESTS         ; Enable watchdog verification testing
    ; Stack size configuration for test execution
    ; v2.10.3: FURTHER INCREASED to fix persistent stack overflow
    ; Tests require additional stack space for comprehensive logging
    ; Loop stack 32KB, Main task 20KB (same as base and test environments)
    -DCONFIG_ARDUINO_LOOP_STACK_SIZE=32768
    -DCONFIG_ESP_MAIN_TASK_STACK_SIZE=20480

; ===================================================================
; No-touch environment for hardware issues
; Restored from v2.8.9 - use if touch is causing SPI bus conflicts
; ===================================================================
[env:esp32-s3-devkitc-no-touch]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ‚Üê HEREDA CONFIG_ESP_IPC_TASK_STACK_SIZE del base
    -DDISABLE_TOUCH             ; Disable touch completely