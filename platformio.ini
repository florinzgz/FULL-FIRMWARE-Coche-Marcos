; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; Hardware: ESP32-S3 DevKitC-1 N16R8 (16MB Flash QIO + 8MB PSRAM OPI)
; Flash: 16MB QIO @ 80MHz (Quad I/O, 4 data lines)
; PSRAM: 8MB OPI (Octal, 8 data lines) @ 80MHz - AP_3v3 vendor
; ============================================================================

[platformio]
boards_dir = boards
default_envs = esp32-s3-devkitc1-n16r8

; ===================================================================
; ACTIVE BOARD: ESP32-S3-DevKitC-1-N16R8
; Custom board manifest with proper USB Serial configuration
; ===================================================================
[env:esp32-s3-devkitc1-n16r8]
platform = espressif32
board = esp32-s3-devkitc1-n16r8
framework = arduino
build_type = debug

monitor_speed = 115200
monitor_filters = esp32_exception_decoder
monitor_rts = 0
monitor_dtr = 0

upload_speed = 921600
upload_port = COM3
monitor_port = COM3

; ================= Stack Size Configuration =================
board_build.arduino.loop_stack_size = 32768
board_build.arduino.event_stack_size = 16384

; ================= Flash & Memory Configuration =================
; ðŸ”’ CRITICAL BOOTLOOP FIX: Force QIO flash mode and OPI PSRAM
; These settings override any ambiguity from board JSON
board_build.flash_mode = qio
board_upload.flash_mode = qio
board_build.arduino.memory_type = qio_opi
board_build.f_flash = 80000000L
board_build.f_cpu = 240000000L

; ================= SDK & Build Flags =================
build_flags = 
    ; Hardware: ESP32-S3 N16R8 has 8MB PSRAM OPI @ 80MHz
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -DARDUINO_USB_CDC_ON_BOOT=0

    ; ---- TFT_eSPI Configuration ----
    ; ðŸ”’ N16R8 ARCHITECTURE FIX: Pins moved to Safe Zone (GPIO 13-17)
    ; Avoids Internal Memory Bus (GPIO 10-12 and 33-37)
    -DUSER_SETUP_LOADED=1
    -DST7796_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    -DTFT_MISO=-1
    -DTFT_MOSI=13
    -DTFT_SCLK=14
    -DTFT_CS=15
    -DTFT_DC=16
    -DTFT_RST=17
    -DTFT_BL=42
    -DTFT_BACKLIGHT_ON=1
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=20000000
    -DSPI_TOUCH_FREQUENCY=2500000
    -DTOUCH_CS=21

    ; ---- Fonts & Graphics ----
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1

    ; ---- System Bus Speed ----
    -DI2C_FREQUENCY=400000
