; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; ============================================================================
; Version: 2.8.9
; Date: 2025-12-02
; Hardware: ESP32-S3-DevKitC-1 (44 pines)
; ============================================================================
; 
; Changelog v2.8.9:
; - SPI frequency increased from 20MHz to 40MHz for ST7796S display
; - Based on TFT_eSPI mySetup27_ST7796_ESP32.h configuration
; - ESP32-S3 supports higher frequencies better than ESP32-C3
; - SPI_READ_FREQUENCY increased to 20MHz for better performance
; - Touch maintained at 2.5MHz (XPT2046 requirement)
; - Using separate XPT2046_Touchscreen library for better reliability
; - Library updates: TFT_eSPI 2.5.43, INA226 0.7.0, FastLED 3.6.0, XPT2046_Touchscreen 1.4
; - Added ESP Async WebServer 1.2.4 for web dashboard support
; - Release build optimizations: -O3, disabled HAL logs, no console UART
;
; Changelog v2.8.5:
; - Comprehensive code review: 57 .cpp + 61 .h files verified
; - Added pin_utils.h, pwm_channels.h, test_display.h/cpp
; - Enhanced safety patterns (nullptr guards, NaN validation, ISR-safe)
; - Production-ready status
;
; Changelog v3.0.0:
; - Fixed 32 critical/medium priority issues
; - Race condition protection, timeout mechanisms
; - 3x PCA9685 architecture (front + rear + steering)
; - Complete GPIO map (35/36 pins utilized)
; ============================================================================

[env:esp32-s3-devkitc]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_size = 16MB
board_build.partitions = default.csv

monitor_speed = 115200
upload_speed = 921600
upload_port = COM4
monitor_port = COM4

lib_deps =
    bodmer/TFT_eSPI @ ^2.5.43
    dfrobot/DFRobotDFPlayerMini @ ^1.0.6
    milesburton/DallasTemperature@^4.0.5
    paulstoffregen/OneWire@^2.3.8
    https://github.com/adafruit/Adafruit-PWM-Servo-Driver-Library.git
    RobTillaart/INA226 @ ^0.7.0
    PaulStoffregen/XPT2046_Touchscreen @ ^1.4
    fastled/FastLED @ ^3.6.0
    adafruit/Adafruit MCP23017 Arduino Library @ ^2.3.2
    https://github.com/stm32duino/VL53L5CX.git#1.2.3
    ESP Async WebServer @ ^1.2.4

build_flags =
    -DCORE_DEBUG_LEVEL=5
    -DUSER_SETUP_LOADED
    -std=gnu++17
    -DLOAD_GLCD
    -DLOAD_FONT2
    -DLOAD_FONT4
    -DLOAD_FONT6
    -DLOAD_FONT7
    -DLOAD_FONT8
    -DSMOOTH_FONT
    -Iinclude
    
    ; ========================================
    ; TFT_eSPI configuration for ST7796S (480x320)
    ; ESP32-S3-N16R8 with HSPI
    ; Pin assignments must match pins.h
    ; ========================================
    -DST7796_DRIVER
    ; CRITICAL: TFT_WIDTH/HEIGHT are NATIVE dimensions BEFORE rotation
    ; ST7796S native orientation is portrait (320x480)
    ; With setRotation(3), display becomes landscape (480x320)
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    
    ; Pin mapping TFT (must match pins.h)
    -DTFT_CS=16
    -DTFT_DC=13
    -DTFT_RST=14
    -DTFT_MOSI=11
    -DTFT_MISO=12
    -DTFT_SCLK=10
    -DTFT_BL=42
    
    ; Touch pins (XPT2046) - using separate library for better reliability
    -DTOUCH_CS=21
    -DTOUCH_IRQ=47
    
    ; Use HSPI bus on ESP32-S3
    -DUSE_HSPI_PORT
    
    ; SPI Frequencies - optimized for ST7796S on ESP32-S3
    ; v2.8.9: 40MHz based on TFT_eSPI recommendation for ST7796
    ; ESP32-S3 handles higher frequencies well
    -DSPI_FREQUENCY=40000000       ; 40MHz for TFT (recommended for ST7796S)
    -DSPI_READ_FREQUENCY=20000000  ; 20MHz for read operations
    -DSPI_TOUCH_FREQUENCY=2500000  ; 2.5MHz for touch (XPT2046 requirement)

    ; I2C Configuration
    -DWIRE_HAS_TIMEOUT
    -DI2C_SDA=8
    -DI2C_SCL=9
    -DI2C_FREQUENCY=400000
    
    ; âœ… AÃ‘ADIDO: ConfiguraciÃ³n PWM para ESP32-S3
    -DLEDC_TIMER_RESOLUTION=10  ; 10-bit resolution para PWM
    -DLEDC_BASE_FREQ=5000       ; 5kHz base frequency
    
    ; ðŸ”§ Suprimir warnings de librerÃ­as externas
    -w
    -Wno-unused-variable
    -Wno-unused-function
    -Wno-unknown-pragmas
    -Wno-macro-redefined
    -Wno-deprecated-declarations
    
    ; Standalone display mode (uncomment for display testing)
    ; -DSTANDALONE_DISPLAY
    ; -DSTANDALONE_TIMEOUT=30000  ; 30 seconds timeout
    
    ; Disable touch completely (uncomment if SPI conflicts)
    ; -DDISABLE_TOUCH

; ===================================================================
; Production environment without debug for better performance
; ===================================================================
[env:esp32-s3-devkitc-release]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DCORE_DEBUG_LEVEL=0        ; No debug in production
    -O3                         ; Maximum performance (speed) - intentionally chosen over -Os; increased binary size is acceptable given 16MB flash
    -DNDEBUG                    ; Disable asserts
    -DCONFIG_ARDUHAL_ESP_LOG=0  ; Disable Arduino HAL logs
    -DCONFIG_ESP_CONSOLE_UART_NONE=1  ; No console UART in production

; ===================================================================
; OTA (Over-The-Air updates) environment
; ===================================================================
[env:esp32-s3-devkitc-ota]
extends = env:esp32-s3-devkitc
upload_protocol = espota
upload_port = 192.168.1.100     ; ESP32 IP address on WiFi network
upload_flags = 
    --port=3232
    --auth=your_ota_password     ; Change to your OTA password
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DENABLE_OTA
    -DOTA_PASSWORD=\"your_ota_password\"
    -DWIFI_SSID=\"your_wifi_ssid\"
    -DWIFI_PASSWORD=\"your_wifi_password\"

; ===================================================================
; Testing environment
; ===================================================================
[env:esp32-s3-devkitc-test]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DCORE_DEBUG_LEVEL=5        ; Maximum debug for testing
    -DTEST_MODE                 ; Enable test mode
    -DSTANDALONE_DISPLAY        ; Standalone mode for display testing
    -DTEST_ALL_LEDS            ; Test all LEDs
    -DTEST_ALL_SENSORS         ; Test all sensors

; ===================================================================
; No-touch environment for hardware issues
; ===================================================================
[env:esp32-s3-devkitc-no-touch]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}
    -DDISABLE_TOUCH             ; Disable touch completely