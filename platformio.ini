; ============================================================================
; ESP32-S3 Car Control System - PlatformIO Configuration
; ============================================================================
; Version: 2.11.5-FIXED
; Date: 2025-12-24
; Hardware: ESP32-S3-N16R8 (16MB Flash, 8MB PSRAM)
; ============================================================================
;
; CRITICAL FIX v2.11.5-FIXED:
; - REVERTED platform to espressif32@6.1.0 (stable, tested version)
; - ADDED critical stack size configurations to prevent reinicios
; - ADDED brownout detector configuration for power stability
; - ADDED panic handler for better debugging
; - MAINTAINED all library versions at stable releases
; ============================================================================

[env:esp32-s3-devkitc]
platform = espressif32@6.1.0    ; ← REVERTIDO a versión estable que funcionaba
board = esp32-s3-devkitc-1
framework = arduino

board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_size = 16MB
board_build.partitions = default.csv

monitor_speed = 115200
upload_speed = 921600
upload_port = COM4
monitor_port = COM4

; Exclude test files from compilation in base environment
build_src_filter = +<*> -<test/>

; ✅ LIBRERÍAS CORREGIDAS PARA VL53L5CX + SISTEMA COMPLETO
lib_deps =
    ; ✅ DISPLAY - Estable y probada
    bodmer/TFT_eSPI @ 2.5.43
    
    ; ✅ AUDIO - Estable
    dfrobot/DFRobotDFPlayerMini @ 1.0.6
    
    ; ✅ SENSORES TEMPERATURA - Versiones estables
    milesburton/DallasTemperature @ 3.11.0
    paulstoffregen/OneWire @ 2.3.7
    
    ; ✅ PWM/SERVO - Versión estable
    adafruit/Adafruit PWM Servo Driver Library @ 2.4.1
    
    ; ✅ I2C/BUS - Versión estable
    adafruit/Adafruit BusIO @ 1.14.5
    
    ; ✅ INA226 - Monitor de corriente estable
    robtillaart/INA226 @ 0.5.1
    
    ; ✅ LEDS - Versión estable con ESP32-S3
    fastled/FastLED @ 3.6.0
    
    ; ✅ MCP23017 - GPIO Expander estable
    adafruit/Adafruit MCP23017 Arduino Library @ 2.3.2
    
    ; ✅ VL53L5CX - SENSOR DE OBSTÁCULOS ESP32-COMPATIBLE
    ; Opción 1: SparkFun (RECOMENDADA - diseñada para Arduino/ESP32)
    https://github.com/sparkfun/SparkFun_VL53L5CX_Arduino_Library.git
    
    ; ✅ MULTIPLEXER PCA9548A para múltiples sensores I2C
    https://github.com/WifWaf/TCA9548A
lib_ignore =
    WebServer

build_flags =
    ; ✅ CONFIGURACIÓN CRÍTICA PARA EVITAR REINICIOS CONTINUOS
    ; ========================================================
    ; Stack sizes aumentados para prevenir stack overflow
    -DCONFIG_ARDUINO_LOOP_STACK_SIZE=32768      ; 32KB loop principal
    -DCONFIG_ARDUINO_TASK_STACK_SIZE=20480      ; 20KB main task
    -DCONFIG_ESP_IPC_TASK_STACK_SIZE=4096       ; 4KB IPC tasks
    -DCONFIG_ESP_MAIN_TASK_STACK_SIZE=16384     ; 16KB main ESP-IDF task
    
    ; ✅ PROTECCIÓN BROWNOUT DETECTOR (previene reinicios por voltage)
    -DCONFIG_ESP_BROWNOUT_DET=1
    -DCONFIG_ESP_BROWNOUT_DET_LVL=ESP_BROWNOUT_DET_LVL7_2V43
    
    ; ✅ PANIC HANDLER: HALT para debugging (cambiar a REBOOT en producción)
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT=1
    -UCONFIG_ESP_SYSTEM_PANIC_PRINT_REBOOT
    
    ; ✅ WATCHDOG CONFIGURATION
    -DCONFIG_ESP_TASK_WDT_EN=1
    -DCONFIG_ESP_TASK_WDT_TIMEOUT_S=30
    -DCONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU0=1
    -DCONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU1=1
    
    ; ✅ HEAP CONFIGURATION
    -DCONFIG_ESP_SYSTEM_ALLOW_RTC_FAST_MEM_AS_HEAP=1
    
    ; ✅ DEBUG LEVEL
    -DCORE_DEBUG_LEVEL=3
    
    ; ✅ CONFIGURACIÓN TFT_eSPI PARA ST7796S
    -DUSER_SETUP_LOADED=1
    -DST7796_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    -DTFT_MISO=12
    -DTFT_MOSI=11  
    -DTFT_SCLK=10
    -DTFT_CS=16
    -DTFT_DC=13
    -DTFT_RST=14
    -DTFT_BL=42
    -DTFT_BACKLIGHT_ON=1
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=20000000
    -DSPI_TOUCH_FREQUENCY=2500000
    -DTOUCH_CS=21
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    -DI2C_FREQUENCY=400000

; ===================================================================
; Production environment without debug for better performance
; ===================================================================
[env:esp32-s3-devkitc-release]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ← HEREDA TODAS LAS CONFIGURACIONES CRÍTICAS
    -DCORE_DEBUG_LEVEL=0        ; No debug in production
    -O3                         ; Maximum performance
    -DNDEBUG                    ; Disable asserts
    -DCONFIG_ARDUHAL_ESP_LOG=0  ; Disable Arduino HAL logs
    -DCONFIG_ESP_CONSOLE_UART_NONE=1  ; No console UART in production
    
    ; ========================================
    ; Production Panic Handler: Auto-Reboot
    ; ========================================
    -UCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_REBOOT=1

; ===================================================================
; Touch debug environment - for troubleshooting touch issues
; ===================================================================
[env:esp32-s3-devkitc-touch-debug]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ← HEREDA CONFIGURACIONES CRÍTICAS
    -USPI_TOUCH_FREQUENCY
    -DSPI_TOUCH_FREQUENCY=1000000
    -DTOUCH_DEBUG
    -UZ_THRESHOLD
    -DZ_THRESHOLD=250
    -UCORE_DEBUG_LEVEL
    -DCORE_DEBUG_LEVEL=5

; ===================================================================
; No-touch environment for hardware issues
; Restored from v2.8.9 - use if touch is causing SPI bus conflicts
; ===================================================================
[env:esp32-s3-devkitc-no-touch]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ← HEREDA CONFIGURACIONES CRÍTICAS
    -DDISABLE_TOUCH

; ===================================================================
; Standalone display environment - for display diagnostics only
; Only display is active, sensors and control systems disabled
; ===================================================================
[env:esp32-s3-devkitc-standalone]
extends = env:esp32-s3-devkitc
build_flags =
    ${env:esp32-s3-devkitc.build_flags}  ; ← HEREDA CONFIGURACIONES CRÍTICAS
    -DSTANDALONE_DISPLAY
    -DDISABLE_SENSORS
    -DSTANDALONE_TIMEOUT=30000
