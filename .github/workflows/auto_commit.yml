name: Firmware Build & Verification

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment:
          - esp32-s3-n16r8
          - esp32-s3-n16r8-release
          - esp32-s3-n16r8-touch-debug
          - esp32-s3-n16r8-no-touch
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio/packages
          ~/.platformio/platforms
          ~/.platformio/toolchains
          ~/.cache/pip
        key: ${{ runner.os }}-pio-${{ hashFiles('platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      run: pip install platformio

    - name: Install platform and packages
      working-directory: ${{ github.workspace }}
      run: |
        pio platform install espressif32@6.12.0
        pio pkg install -e ${{ matrix.environment }}

    - name: Build firmware (${{ matrix.environment }})
      working-directory: ${{ github.workspace }}
      run: |
        pio run -t clean -e ${{ matrix.environment }}
        pio run -e ${{ matrix.environment }}

    - name: Verify sdkconfig was generated (${{ matrix.environment }})
      working-directory: ${{ github.workspace }}
      run: |
        if [ -f ".pio/build/${{ matrix.environment }}/config/sdkconfig.h" ]; then
          echo "âœ… sdkconfig.h OK for ${{ matrix.environment }}"
        else
          echo "âŒ sdkconfig.h missing for ${{ matrix.environment }}"
          exit 1
        fi

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.environment }}
        path: .pio/build/${{ matrix.environment }}/firmware.bin
        if-no-files-found: error

  verify:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Verify build outputs
      run: |
        EXPECTED_ENVS=("esp32-s3-n16r8" "esp32-s3-n16r8-release" "esp32-s3-n16r8-touch-debug" "esp32-s3-n16r8-no-touch")
        TOTAL_ENVIRONMENTS=${#EXPECTED_ENVS[@]}

        BUILD_COUNT=$(find artifacts -name "firmware.bin" | wc -l)

        if [ "$BUILD_COUNT" -ne "$TOTAL_ENVIRONMENTS" ]; then
          echo "âŒ Some builds failed"
          exit 1
        fi

        find artifacts -name "firmware.bin" -exec ls -lh {} \;

    - name: Generate verification report
      run: |
        EXPECTED_ENVS=("esp32-s3-n16r8" "esp32-s3-n16r8-release" "esp32-s3-n16r8-touch-debug" "esp32-s3-n16r8-no-touch")

        echo "# ðŸ”§ Firmware Verification Report" > VERIFICATION_REPORT.md
        echo "" >> VERIFICATION_REPORT.md
        echo "**Commit:** ${{ github.sha }}" >> VERIFICATION_REPORT.md
        echo "**Branch:** ${{ github.ref_name }}" >> VERIFICATION_REPORT.md
        echo "" >> VERIFICATION_REPORT.md
        echo "| Environment | Status | Size |" >> VERIFICATION_REPORT.md
        echo "|-------------|--------|------|" >> VERIFICATION_REPORT.md

        for env in "${EXPECTED_ENVS[@]}"; do
          if [ -f "artifacts/firmware-$env/firmware.bin" ]; then
            SIZE=$(ls -lh "artifacts/firmware-$env/firmware.bin" | awk '{print $5}')
            echo "| $env | âœ… OK | $SIZE |" >> VERIFICATION_REPORT.md
          else
            echo "| $env | âŒ FAIL | - |" >> VERIFICATION_REPORT.md
          fi
        done

    - name: Upload verification report
      uses: actions/upload-artifact@v4
      with:
        name: verification-report
        path: VERIFICATION_REPORT.md
