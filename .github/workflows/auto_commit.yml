name: Firmware Build & Verification

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:   # Permite lanzarlo manualmente desde Actions

permissions:
  contents: read   # Only read access needed since we don't commit

jobs:
  # ============================================
  # Job 1: Build all firmware environments
  # ============================================
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: 
          - esp32-s3-devkitc
          - esp32-s3-devkitc-release
          - esp32-s3-devkitc-ota
          - esp32-s3-devkitc-test
      fail-fast: false
    
    steps:
    # 1. Checkout del repo
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Cache PlatformIO dependencies
    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          ~/.cache/pip
        key: ${{ runner.os }}-pio-${{ hashFiles('platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-

    # 3. Instalar Python y PlatformIO
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      run: pip install platformio

    # 4. Compilar el firmware para el entorno especificado
    - name: Build firmware (${{ matrix.environment }})
      run: pio run -e ${{ matrix.environment }}

    # 5. Subir artefactos de compilaciÃ³n
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.environment }}
        path: .pio/build/${{ matrix.environment }}/firmware.bin
        if-no-files-found: error

  # ============================================
  # Job 2: Verification and summary
  # ============================================
  verify:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Verify build outputs
      run: |
        echo "ðŸ” VerificaciÃ³n de compilaciÃ³n de firmware"
        echo "=========================================="
        
        # Expected environments (must match matrix above)
        EXPECTED_ENVS=("esp32-s3-devkitc" "esp32-s3-devkitc-release" "esp32-s3-devkitc-ota" "esp32-s3-devkitc-test")
        TOTAL_ENVIRONMENTS=${#EXPECTED_ENVS[@]}
        
        # Count successful builds
        BUILD_COUNT=$(find artifacts -name "firmware.bin" | wc -l)
        echo "âœ… Compilaciones exitosas: $BUILD_COUNT/$TOTAL_ENVIRONMENTS"
        
        # List all firmware files with sizes
        echo ""
        echo "ðŸ“¦ Artefactos generados:"
        find artifacts -name "firmware.bin" -exec ls -lh {} \;
        
        # Verify all expected builds exist
        if [ "$BUILD_COUNT" -eq "$TOTAL_ENVIRONMENTS" ]; then
          echo ""
          echo "âœ… Todos los entornos compilaron correctamente"
        else
          echo ""
          echo "âŒ Algunos entornos fallaron la compilaciÃ³n"
          exit 1
        fi

    - name: Generate verification report
      run: |
        # Expected environments (must match matrix above)
        EXPECTED_ENVS=("esp32-s3-devkitc" "esp32-s3-devkitc-release" "esp32-s3-devkitc-ota" "esp32-s3-devkitc-test")
        
        echo "# ðŸ”§ Firmware Verification Report" > VERIFICATION_REPORT.md
        echo "" >> VERIFICATION_REPORT.md
        echo "**Fecha:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> VERIFICATION_REPORT.md
        echo "**Commit:** ${{ github.sha }}" >> VERIFICATION_REPORT.md
        echo "**Branch:** ${{ github.ref_name }}" >> VERIFICATION_REPORT.md
        echo "" >> VERIFICATION_REPORT.md
        echo "## ðŸ“Š Resultados de CompilaciÃ³n" >> VERIFICATION_REPORT.md
        echo "" >> VERIFICATION_REPORT.md
        echo "| Entorno | Estado | TamaÃ±o |" >> VERIFICATION_REPORT.md
        echo "|---------|--------|--------|" >> VERIFICATION_REPORT.md
        
        # Iterate using proper bash array
        for env in "${EXPECTED_ENVS[@]}"; do
          if [ -f "artifacts/firmware-$env/firmware.bin" ]; then
            SIZE=$(ls -lh "artifacts/firmware-$env/firmware.bin" | awk '{print $5}')
            echo "| $env | âœ… OK | $SIZE |" >> VERIFICATION_REPORT.md
          else
            echo "| $env | âŒ FAIL | - |" >> VERIFICATION_REPORT.md
          fi
        done
        
        echo "" >> VERIFICATION_REPORT.md
        echo "## âœ… Verificaciones Pasadas" >> VERIFICATION_REPORT.md
        echo "" >> VERIFICATION_REPORT.md
        echo "- [x] Todas las dependencias instaladas correctamente" >> VERIFICATION_REPORT.md
        echo "- [x] CÃ³digo compila sin errores" >> VERIFICATION_REPORT.md
        echo "- [x] Artefactos de firmware generados" >> VERIFICATION_REPORT.md
        echo "- [x] Todos los entornos (dev, release, OTA, test) verificados" >> VERIFICATION_REPORT.md
        echo "" >> VERIFICATION_REPORT.md
        echo "---" >> VERIFICATION_REPORT.md
        echo "*Generado automÃ¡ticamente por GitHub Actions*" >> VERIFICATION_REPORT.md

    - name: Upload verification report
      uses: actions/upload-artifact@v4
      with:
        name: verification-report
        path: VERIFICATION_REPORT.md
