name: SonarCloud Full Audit

on:
  push:   
    branches: [ "main" ]
  schedule:
    - cron: "0 3 * * 0"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events:  write

jobs:
  sonarcloud:  
    runs-on: ubuntu-latest

    steps: 
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('platformio.ini') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 python3-pip

      - name: Install PlatformIO
        run: |
          pip install platformio

      - name: Build firmware and generate compile_commands.json
        run: |
          pio run -e esp32-s3-devkitc1
          pio run -e esp32-s3-devkitc1 -t compiledb --ide clion

      - name: Debug compile_commands.json location
        run: |
          find . -name "compile_commands.json" -type f

      - name: Verify compile_commands.json exists
        run: |
          if [ ! -f .pio/build/esp32-s3-devkitc1/compile_commands.json ]; then
            echo "Error: compile_commands.json not found"
            exit 1
          fi
          echo "âœ“ compile_commands. json generated successfully"

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
