# ============================================================================
# ESP32-S3 DevKitC-1 Car Control System - Project Configuration
# ============================================================================
# This file documents all hardware components, firmware features, and 
# configurations for the complete vehicle control system.
# Reference this file when working with platformio.ini or documentation.
# ============================================================================

[project]
name = ESP32-S3 Car Control System
version = 2.0.0
board = ESP32-S3-DevKitC-1 (N16R8)
mcu = ESP32-S3
flash_size = 16MB
psram_size = 8MB
cpu_freq = 240MHz

# ============================================================================
# HARDWARE COMPONENTS INVENTORY
# ============================================================================

[display]
model = ST7796S
resolution = 480x320 (landscape orientation)
interface = SPI (HSPI)
driver = TFT_eSPI
touch_controller = XPT2046
touch_interface = SPI (shared with display)
backlight_control = PWM on GPIO42

[motor_control]
driver_type = BTS7960 (43A per motor)
quantity = 4 (FL, FR, RL, RR)
pwm_controller = PCA9685 @ I2C 0x40
direction_controller = MCP23017 @ I2C 0x20
power_switching = 4x SRD-05VDC relays with optocouplers
control_method = I2C (non-blocking)

[power_monitoring]
sensor_type = INA226
quantity = 6 sensors
i2c_multiplexer = TCA9548A @ 0x70
shunt_resistors = 1x CG FL-2C 100A/75mV, 5x CG FL-2C 50A/75mV
monitored_lines = 12V_Main, 12V_Aux, 24V_Motors, Motor_FL, Motor_FR, Motor_RL, Motor_RR

[temperature_sensors]
sensor_type = DS18B20 (1-Wire)
quantity = 4
locations = Motor_FL, Motor_FR, Motor_RL, Motor_RR
interface = OneWire on GPIO9

[wheel_speed_sensors]
sensor_type = LJ12A3-4-Z/BX (inductive proximity)
quantity = 4
signal_conditioning = HY-M158 optocoupler (12V to 3.3V)
interface_wheel0 = ESP32 GPIO35 (interrupt)
interface_wheel1 = MCP23017 GPIOB0 (polling)
interface_wheel2 = ESP32 GPIO36 (interrupt)
interface_wheel3 = ESP32 GPIO37 (interrupt)

[encoder]
model = E6B2-CWZ6C (600 PPR)
interface = HY-M158 optocoupler module
signals = A, B, Z
gpio_a = GPIO17
gpio_b = GPIO18
gpio_z = GPIO16

[pedal_input]
sensor_type = A1324LUA-T Hall Effect
voltage_output = 0-5V
voltage_divider = Required (5V to 3.3V)
gpio = GPIO7 (ADC capable)

[audio]
module = DFPlayer Mini
interface = UART2
gpio_tx = GPIO43
gpio_rx = GPIO44
storage = MicroSD card

[leds]
type = WS2812B addressable RGB
quantity_front = 28 LEDs
quantity_rear = 16 LEDs
gpio_front = GPIO21
gpio_rear = GPIO1
library = FastLED

[user_inputs]
shifter = HY-M158 module (3 positions)
buttons = HY-M158 module (multiple buttons)
system_key = GPIO0 (Boot button, power/ignition control)

# ============================================================================
# I2C DEVICE MAP
# ============================================================================

[i2c_main_bus]
sda = GPIO8
scl = GPIO9
frequency = 400kHz

[i2c_devices]
# Address 0x20: Motor control (MCP23017)
mcp23017_motors = 0x20
  ; GPIOA0-1: FL motor IN1/IN2
  ; GPIOA2-3: FR motor IN1/IN2
  ; GPIOA4-5: RL motor IN1/IN2
  ; GPIOA6-7: RR motor IN1/IN2
  ; GPIOB0: WHEEL1 sensor (FR)
  ; GPIOB1-7: Available for expansion

# Address 0x40: PWM generation (PCA9685)
pca9685_pwm = 0x40
  ; Channel 0-1: FL motor PWM
  ; Channel 2-3: FR motor PWM
  ; Channel 4-5: RL motor PWM
  ; Channel 6-7: RR motor PWM
  ; Channels 8-15: Available

# Address 0x70: I2C multiplexer (TCA9548A)
tca9548a_mux = 0x70
  ; Channel 0: INA226 @ 0x40 (12V Main)
  ; Channel 1: INA226 @ 0x40 (12V Aux)
  ; Channel 2: INA226 @ 0x40 (24V Motors)
  ; Channel 3: INA226 @ 0x40 (Motor FL)
  ; Channel 4: INA226 @ 0x40 (Motor FR)
  ; Channel 5: INA226 @ 0x40 (Motor RL)
  ; Channel 6: INA226 @ 0x40 (Motor RR)
  ; Channel 7: Available

# Note: No I2C address conflicts - INA226 sensors share 0x40 but are 
# multiplexed through TCA9548A channels

# ============================================================================
# SPI CONFIGURATION
# ============================================================================

[spi_hspi]
bus = HSPI
mosi = GPIO11
miso = GPIO12
sclk = GPIO10
frequency_tft = 20MHz
frequency_touch = 2.5MHz

[spi_devices]
display_cs = GPIO8
display_dc = GPIO13
display_rst = GPIO14
display_bl = GPIO42
touch_cs = GPIO3
touch_irq = GPIO46

# ============================================================================
# GPIO PIN ASSIGNMENTS
# ============================================================================

[gpio_map]
# System Control
gpio_0 = KEY_SYSTEM (Boot button - power/ignition)

# LEDs
gpio_1 = LED_REAR (WS2812B x16)
gpio_21 = LED_FRONT (WS2812B x28)

# Power Relays
gpio_2 = RELAY_MAIN (Power hold)
gpio_4 = RELAY_TRAC (12V Auxiliary)
gpio_5 = RELAY_DIR (24V Motors)
gpio_6 = RELAY_SPARE (Reserved)

# Analog Input
gpio_7 = PEDAL_HALL (ADC - with voltage divider)

# I2C Bus
gpio_8 = I2C_SDA (Main bus)
gpio_9 = I2C_SCL (Main bus)

# SPI Bus (HSPI)
gpio_10 = SPI_CLK (Display & Touch)
gpio_11 = SPI_MOSI (Display & Touch)
gpio_12 = SPI_MISO (Display & Touch)

# Display Control
gpio_13 = TFT_DC (Data/Command)
gpio_14 = TFT_RST (Reset)
gpio_8 = TFT_CS (Chip Select) # Note: Shares with I2C_SDA - verify!

# Encoder
gpio_16 = ENCODER_Z (Index)
gpio_17 = ENCODER_A (Phase A)
gpio_18 = ENCODER_B (Phase B)

# Temperature Sensors
gpio_9 = ONEWIRE_BUS (DS18B20 x4) # Note: Shares with I2C_SCL - verify!

# Wheel Speed Sensors (ESP32 direct)
gpio_35 = WHEEL0_SENSOR (FL - interrupt)
gpio_36 = WHEEL2_SENSOR (RL - interrupt)
gpio_37 = WHEEL3_SENSOR (RR - interrupt)
# gpio_WHEEL1 = MCP23017 GPIOB0 (FR - polling)

# Display & Touch
gpio_42 = TFT_BACKLIGHT (PWM)
gpio_3 = TOUCH_CS (Chip Select)
gpio_46 = TOUCH_IRQ (Interrupt/Pen detect)

# UART (DFPlayer)
gpio_43 = UART_TX (DFPlayer)
gpio_44 = UART_RX (DFPlayer)

# Reserved/Available GPIOs
# gpio_15, gpio_19, gpio_20, gpio_38, gpio_39, gpio_40, gpio_41, gpio_45, gpio_47, gpio_48

# ============================================================================
# FIRMWARE FEATURES
# ============================================================================

[timing]
architecture = Non-blocking (millis-based)
delay_calls_removed = Yes (except watchdog panic)
main_loop_frequency = Maximum (no throttling)
watchdog_enabled = Yes
watchdog_timeout = 8 seconds

[module_update_rates]
hud = 30 FPS (33ms interval)
current_sensors = 20 Hz (50ms interval)
temperature = 1 Hz (1000ms interval)
wheel_sensors = 10 Hz (100ms interval)
led_effects = 20 Hz (50ms interval, configurable)
motor_control = As needed (non-blocking)

[safety_features]
power_hold_relay = GPIO2 (prevents shutdown on key release)
emergency_flash = Non-blocking state machine
watchdog_protection = Automatic reset on hang
voltage_monitoring = Real-time via INA226
temperature_monitoring = Motor overheating detection
current_limiting = Via BTS7960 drivers

[communication]
serial_monitor = 115200 baud
upload_speed = 921600 baud
debug_level = 5 (CORE_DEBUG_LEVEL)
wifi_support = Async initialization

# ============================================================================
# POWER ARCHITECTURE
# ============================================================================

[power_flow]
description = """
12V Battery → Fuses → Relay Module → BTS7960 Drivers → Motors
                  ↓
              ESP32-S3 (3.3V regulator)
                  ↓
              Sensors, Display, I2C modules
"""

[relays]
type = SRD-05VDC with optocouplers
control_voltage = 5V
switching_capacity = 10A @ 250VAC, 10A @ 30VDC
quantity = 4
function_main = Power hold (latching)
function_trac = 12V auxiliary power
function_dir = 24V motor power enable
function_spare = Reserved for expansion

[motor_drivers]
model = BTS7960
current_rating = 43A continuous per driver
quantity = 4
input_voltage = 12V or 24V
control_signals = IN1, IN2 (direction), PWM (speed)
protection = Overcurrent, overtemperature, short-circuit

# ============================================================================
# LIBRARIES AND DEPENDENCIES
# ============================================================================

[platformio_libraries]
tft_display = bodmer/TFT_eSPI @ ^2.5.43
audio = dfrobot/DFRobotDFPlayerMini @ ^1.0.6
temperature = milesburton/DallasTemperature @ ^4.0.5
onewire = paulstoffregen/OneWire @ ^2.3.8
pwm_driver = Adafruit-PWM-Servo-Driver-Library (GitHub)
current_sensor = RobTillaart/INA226 @ ^0.6.4
touch = XPT2046_Touchscreen (GitHub)
leds = fastled/FastLED @ 3.6.0

[build_flags]
user_setup_loaded = Yes (TFT_eSPI configured in platformio.ini)
cpp_standard = gnu++17
core_debug_level = 5
warning_suppression = Enabled for external libraries

# ============================================================================
# PROTECTIONS AND RECOMMENDATIONS
# ============================================================================

[electrical_protections]
fuses_12v = Required on all 12V power lines
fuses_24v = Required on motor power lines
diodes = Reverse polarity protection on power inputs
voltage_dividers = Hall sensor (5V to 3.3V)
optocouplers = HY-M158 for 12V/24V signal isolation
level_shifters = I2C (5V to 3.3V if needed)
pull_resistors = I2C pull-ups (internal or external 4.7kΩ)

[safety_recommendations]
double_check_wiring = Before applying power
verify_voltage_levels = All signals within ESP32 limits (3.3V max)
test_relays = Ensure proper switching before motor connection
current_monitoring = Watch INA226 readings for overcurrent
temperature_monitoring = Monitor motor temperatures
emergency_stop = Implement physical emergency stop button
shunt_sizing = Verify shunt resistor current ratings

# ============================================================================
# DOCUMENTATION REFERENCES
# ============================================================================

[documentation_files]
technical_manual = docs/MANUAL_TECNICO_CONEXIONES.md
recent_changes = docs/CAMBIOS_RECIENTES.md
timing_architecture = docs/NON_BLOCKING_TIMING.md
pin_mapping = docs/PIN_MAPPING_DEVKITC1.md
hardware_connections = docs/CONEXIONES_HARDWARE_DEVKITC1.md

[schematics]
i2c_bus = Documented in technical manual
power_flow = Documented in technical manual
relay_connections = Documented in technical manual
motor_control = Documented in recent changes document

# ============================================================================
# KNOWN ISSUES AND LIMITATIONS
# ============================================================================

[limitations]
gpio_23_34_unavailable = ESP32-S3 does not expose GPIO 23-34 on headers
direct_motor_control = Not possible, requires I2C expansion (PCA9685 + MCP23017)
interrupt_limit = WHEEL1 moved to polling (MCP23017) to free GPIO
psram_usage = 8MB available but may require specific configuration

[resolved_issues]
blocking_delays = Removed from all modules
gpio_conflicts = Resolved (key vs LEDs, invalid pin references)
display_initialization = Fixed with complete TFT_eSPI configuration
pin_compatibility = All pins verified available on ESP32-S3-DevKitC-1

# ============================================================================
# EXPANSION POSSIBILITIES
# ============================================================================

[future_expansion]
mcp23017_gpio_available = GPIOB1-7 (7 pins free)
pca9685_channels_available = 8-15 (8 channels free)
tca9548a_channel_available = Channel 7
additional_mcp23017 = Can add up to 7 more @ 0x21-0x27
additional_sensors = Temperature, current, proximity
sd_card_logging = Possible via SPI or SDIO
can_bus = Possible with external transceiver
bluetooth = ESP32-S3 built-in (not yet implemented)
wifi_ota = Possible with WiFi module updates

# ============================================================================
# COMPILATION AND UPLOAD
# ============================================================================

[build_instructions]
command_compile = pio run
command_upload = pio run --target upload
command_monitor = pio device monitor
command_clean = pio run --target clean
upload_port = COM3 (Windows) or /dev/ttyUSB0 (Linux)

[troubleshooting]
display_black = Check SPI pins, TFT_CS, backlight, power
motors_not_responding = Verify I2C bus, PCA9685, MCP23017, relay power
compilation_errors = Check library versions, GPIO pin conflicts
upload_fails = Verify upload_port, press BOOT button if needed
watchdog_resets = Check for blocking code, increase timeout if needed

# ============================================================================
# VERSION HISTORY
# ============================================================================

[changelog]
v2.0.0 = """
- Removed all blocking delay() calls
- Implemented non-blocking millis-based timing
- Fixed GPIO pin mappings for ESP32-S3
- Implemented I2C motor control (PCA9685 + MCP23017)
- Resolved GPIO conflicts (key, LEDs, non-existent pins)
- Fixed ILI9488 display configuration (HSPI, pin mappings)
- Added comprehensive technical documentation
- Fixed WHEEL1 interrupt issue (moved to MCP23017 polling)
"""

v1.0.0 = """
- Initial firmware version
- Basic motor control
- Display interface
- Sensor integration
"""

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
